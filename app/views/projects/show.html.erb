<div class="bg-white rounded-lg shadow p-6 mb-6">
  <div class="flex justify-between items-center mb-4">
    <div>
      <h1 class="text-2xl font-bold"><%= @project.name %></h1>
      <p class="text-gray-600">
        <%= link_to @organization.name, @organization, class: "text-blue-600 hover:underline" %> • 
        <%= pluralize(@time_entries.count, 'time entry') %>
      </p>
    </div>
    <div class="flex space-x-3">
      <%= link_to "Edit Project", edit_organization_project_path(@organization, @project), 
                  class: "bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" %>
    </div>
  </div>
  
  <% if @project.description.present? %>
    <p class="text-gray-700 mb-4"><%= @project.description %></p>
  <% end %>
</div>

<!-- Time Tracking Section -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
  <h2 class="text-xl font-semibold mb-4">Time Tracking</h2>
  
  <% if @active_entry %>
    <!-- Active Timer -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="font-medium text-green-800">Timer Running</h3>
          <p class="text-green-700"><%= @active_entry.description %></p>
          <p class="text-sm text-green-600">
            Started: <%= @active_entry.start_time.strftime("%I:%M %p") %> 
            (<span id="elapsed-time" data-start="<%= @active_entry.start_time.to_i %>">calculating...</span>)
          </p>
        </div>
        <div class="flex space-x-2">
          <%= link_to "Stop", stop_time_entry_path(@active_entry), 
                      method: :patch, 
                      class: "bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Start Timer Form -->
    <div class="border border-gray-200 rounded-lg p-4 mb-4">
      <%= form_with model: [@project, TimeEntry.new], local: true, class: "flex space-x-3 items-end" do |form| %>
        <div class="flex-1">
          <%= form.label :description, "What are you working on?", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_field :description, 
                              placeholder: "e.g., Fixing user authentication bug", 
                              class: "w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= form.submit "Start Timer", class: "bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600" %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Time Entries List -->
<div class="bg-white rounded-lg shadow p-6">
  <h2 class="text-xl font-semibold mb-4">Time Entries</h2>
  
  <% if @time_entries.any? %>
    <div class="space-y-3">
      <% @time_entries.each do |entry| %>
        <div class="border border-gray-200 rounded-lg p-4 <%= 'bg-green-50' if entry.in_progress? %>">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="font-medium"><%= entry.description %></h3>
              <div class="text-sm text-gray-600 mt-1">
                <strong><%= entry.user.full_name %></strong> • 
                <%= entry.start_time.strftime("%m/%d/%Y at %I:%M %p") %>
                <% if entry.end_time %>
                  - <%= entry.end_time.strftime("%I:%M %p") %>
                  (<%= entry.duration_in_hours.round(2) %> hours)
                <% else %>
                  <span class="text-green-600 font-medium">• In Progress</span>
                <% end %>
              </div>
            </div>
            <div class="flex space-x-2">
              <% if entry.user == current_user %>
                <% if entry.in_progress? %>
                  <%= link_to "Stop", stop_time_entry_path(entry), 
                              method: :patch, 
                              class: "text-red-600 hover:underline text-sm" %>
                <% end %>
                <%= link_to "Delete", [@project, entry], 
                            method: :delete, 
                            data: { confirm: "Are you sure?" }, 
                            class: "text-red-600 hover:underline text-sm" %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="text-gray-500">No time entries yet. Start your first timer above!</p>
  <% end %>
</div>

<!-- Live Timer JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const timerElement = document.getElementById('elapsed-time');
  if (timerElement) {
    const startTime = parseInt(timerElement.dataset.start) * 1000;
    
    function updateTimer() {
      const now = new Date().getTime();
      const elapsed = now - startTime;
      
      const hours = Math.floor(elapsed / (1000 * 60 * 60));
      const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
      
      timerElement.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    updateTimer();
    setInterval(updateTimer, 1000);
  }
});
</script>
